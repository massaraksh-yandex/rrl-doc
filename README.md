Репозиторий содержит результаты работы по RRL в PowerDNS

СПИСОК ФАЙЛОВ
-----------------
 * rrl-config - часть конфигурационного файла для pdns_recursor с пояснениями
 * special_limits.conf - конфигурационный файл с лимитами для разных сетей
 * white_list.conf - конфигурационный файл со списком адресов, для которых блокировка не будет срабатывать
 * pdns-recursor_20140427~lucid1-yandex1_amd64.deb - собранный пакет с PowerDNS

АЛГОРИТМ РАБОТЫ
---------------
Для включения RRL необходимо добавить в конфигурационный файл строчку
	
    rrl-enable=yes

При первом запросе по UDP происходит инициализация параметров для работы RRL. Если накосячили с конфигами, то может обнаружиться только на этом этапе.
Алгоритм работает не с ip адресами, а сетями. Длина префикса задаётся для IPv4 и IPv6 задаётся следующим и параметрами

    rrl-ipv4-prefix-length=24
    rrl-ipv6-prefix-length=56

При поступлении запроса на адрес накладывается макса, после этого в таблице ищутся данные для конкретной подсети и ответ на DNS запрос. Если запрос/ответ подходит под определённые критерии, то мы увеличиваем счётчики и смотрим не пора ли блокировать подсеть.
Критерии блокировки

    rrl-types=ANY,RRSIG
    rrl-ratio=5.0
    rrl-limit-types-count=50
    rrl-limit-ratio-count=50

Если решаем блокировать, то возможно послать TRUNCATE, а можно просто игнорить. 

    rrl-drop-requests=no # посылаем TRUNCATE

Если общее число запросов за определённое время (detection-period) слишком большое, то подсеть блокируется на время blocking-period. При этом счётчики запросов постепенно "остывают", однако не перестают считать приходящие запросы. Время измеряется в миллисекундах. 

    rrl-detection-period=10
    rrl-blocking-period=20 

ЛОГГИРОВАНИЕ
------------
Есть возможность перенаправить логи по (раз)блокировке в файл

    rrl-enable-log-file=yes
    rrl-log-file=/home/massaraksh/powerdns/rrl.log

БЕЛЫЙ СПИСОК И ОСОБЫЕ ОГРАНИЧЕНИЯ
---------------------------------
Можно создать список подсетей, которые будут пропускаться и не учитываться счётчиком запросов. Файл со списком определяется rrl-white-list. Пример файла: white_list.conf

    rrl-enable-white-list=yes
    rrl-white-list=/home/massaraksh/powerdns/white_list.conf

Так же можно задать для некоторых подсетей отдельные ограничения. Пример файла: special_limits.conf
    
    rrl-enable-special-limits=yes
    rrl-special-limits=/home/massaraksh/powerdns/special_limits.conf

ИСХОДНЫЙ КОД
------------
https://github.com/massaraksh-yandex/pdns, ветка rrl-implementation, rec-3.5.2-with_rrl
